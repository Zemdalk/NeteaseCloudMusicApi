<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>歌单分析</title>
</head>

<style>
    body{
        text-align: center;
        background-color: #dff0d8;
    }
    /* .box{
        padding: 15px;
        border: 1px solid #d6e9c6;
        border-radius: 4px;
        color: #3c763d;
        background-color: #dff0d8;
    } */
    table.gridtable {
        margin: 0 auto;
        font-family: verdana,arial,sans-serif;
        font-size:11px;
        color:#333333;
        border-width: 1px;
        border-color: #666666;
        border-collapse: collapse;
    }
    table.gridtable th {
        border-width: 1px;
        padding: 8px;
        height: 10px;
        width: 200px;
        text-align: center;
        border-style: solid;
        border-color: #666666;
        background-color: #dedede;
    }
    table.gridtable td {
        border-width: 1px;
        padding: 8px;
        height: 50px;
        width: 200px;
        text-align: center;
        border-style: solid;
        border-color: #666666;
        background-color: #ffffff;
    }
</style>

<body>
    <div id="getUsers" class="box">
        <p>请输入用户名</p>
        <input type="text" id="userInput">
        <button id="UsernameSubmitBtn">Submit</button>
        <p> </p>
        <table id="users" class="gridtable" border="1"> </table>
        <!-- <div id="playlists"> </div> -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@0.26.1/dist/axios.min.js"></script>

    <script>
        async function getUserByName(){
            let UsernameSubmitBtn = document.getElementById('UsernameSubmitBtn')
            UsernameSubmitBtn.addEventListener(
                'click',
                function(){
                    searchUserByName(document.getElementById('userInput').value)
                }
            )
            console.log("hello");
        }

        async function searchUserByName(username, limit = 10){
            // console.log(username);
            const res = await axios({
                method: 'post',
                timeout: 5000,
                url: `/search?keywords=${username}&type=1002&limit=${limit}&timerstamp=${Date.now()}`,
            });
            let data = res.data.result;
            // console.log(data);
            let oldTable = document.querySelector('#userlist');
            // console.log(oldTable);
            if(oldTable){
                oldTable.remove();
            }

            let div = document.createElement('div');
            div.id = 'userlist';

            let table = document.createElement('table');
            let th = document.createElement('tr');
            let th_num = document.createElement('th');
            let th_avatar = document.createElement('th');
            let th_name = document.createElement('th');

            th_num.innerText = 'Num';
            th_num.style.width = '50px';
            th.appendChild(th_num);
            th_avatar.innerText = 'Avatar';
            th_avatar.style.width = '50px';
            th.appendChild(th_avatar);
            th_name.innerText = 'Username';
            th_name.style.width = '200px';
            th.appendChild(th_name);
            table.appendChild(th);
            
            for(let i=0; i < Math.min(data.userprofileCount, limit); i++){
                let row = document.createElement('tr');
                let num = document.createElement('td');
                let avatar = document.createElement('td');
                let nickname = document.createElement('td');

                num.innerText = i+1;
                num.style.width = '50px';

                let img = document.createElement('img');
                try {
                    img.src = data.userprofiles[i].avatarUrl;
                } catch (e) {
                    console.log(e);
                    console.log(`error location: user ${i+1}`);
                }
                img.height = '40';
                img.width = '40';
                avatar.style.width = '50px';
                avatar.appendChild(img);
                
                nickname.innerText = data.userprofiles[i].nickname;
                
                row.appendChild(num);
                row.appendChild(avatar);
                row.appendChild(nickname);
                table.appendChild(row);
                // console.log(i);
            }
            div.appendChild(table);

            let findTargetUserPrompt = document.createElement('p');
            findTargetUserPrompt.innerText = '请输入搜寻用户的序号：';
            let targetNum = document.createElement('input');
            targetNum.type = 'text';
            targetNum.id = 'targetNum';
            let targetNumSubmitBtn = document.createElement('button');
            targetNumSubmitBtn.innerText = 'Submit';
            div.appendChild(findTargetUserPrompt);
            div.appendChild(targetNum);
            div.appendChild(targetNumSubmitBtn);
            let retNum;
            targetNumSubmitBtn.addEventListener(
                'click',
                function() {
                    let uid = data.userprofiles[targetNum.value - 1].userId;
                    getUserPlaylist(uid);
                }
            )
            // console.log(retNum);
            
            document.getElementById('users').appendChild(div);
        }

        async function getUserPlaylist(uid, limit = 30){
            console.log(uid);
            const res = await axios({
                method: 'post',
                timeout: 5000,
                url: `/user/playlist?uid=${uid}&timerstamp=${Date.now()}`,
            });
            let data = res.data.playlist;
            console.log(res);

            let oldPlaylists = document.querySelector('#playlists');
            console.log(oldPlaylists);
            if(oldPlaylists){
                oldPlaylists.remove();
            }

            let playlists = document.createElement('div');
            playlists.id = 'playlists';
            let playlistFoundPrompt = document.createElement('p');
            playlistFoundPrompt.innerText = `该用户歌单列表（前${limit}个）：`;
            playlists.appendChild(playlistFoundPrompt);

            let table = document.createElement('table');
            table.classList = 'gridtable';
            let th = document.createElement('tr');
            let th_num = document.createElement('th');
            let th_name = document.createElement('th');
            let th_creator = document.createElement('th');

            th_num.innerText = 'Num';
            // th_num.style.width = '50px';
            th_name.innerText = 'Playlistname';
            th_creator.innerText = 'Creator';
            th.appendChild(th_num);
            th.appendChild(th_name);
            th.appendChild(th_creator);
            table.appendChild(th);

            let listCount = data.length;
            for(let i = 0; i < listCount; i++){
                let row = document.createElement('tr');
                let num = document.createElement('td');
                let playlistName = document.createElement('td');
                let creator = document.createElement('td');

                num.innerText = i+1;
                playlistName.innerText = data[i].name;
                creator.innerText = data[i].creator.nickname;

                row.appendChild(num);
                row.appendChild(playlistName);
                row.appendChild(creator);
                table.appendChild(row);
            }
            playlists.appendChild(table);

            document.getElementById('getUsers').appendChild(playlists);
        }
        getUserByName();
    </script>

</body>

</html>